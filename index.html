<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease Mileage Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-section {
            margin: 20px 0;
            text-align: center;
        }
        .input-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .input-section input[type="number"] {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        .input-section select {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat {
            background: #e9f7ef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
        }
        .stat.over {
            background: #d4edda;
            color: #155724;
        }
        .stat.under {
            background: #f8d7da;
            color: #721c24;
        }
        .note {
            font-size: 0.8em;
            color: #888;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lease Mileage Tracker</h1>
        <p style="text-align: center; color: #666;">Select lease start date and annual miles below. Enter actual miles used.</p>
        
        <div class="input-section">
            <label for="startDateSelect">Lease Start Date:</label>
            <select id="startDateSelect">
                <option value="2025-04-23">April 23, 2025</option>
                <option value="2025-08-09" selected>August 9, 2025</option>
            </select>
        </div>
        
        <div class="input-section">
            <label for="annualMilesSelect">Annual Miles Allotted:</label>
            <select id="annualMilesSelect">
                <option value="10000">10,000</option>
                <option value="15000" selected>15,000</option>
            </select>
        </div>
        
        <div class="input-section">
            <label for="actualMiles">Actual Miles Driven:</label>
            <input type="number" id="actualMiles" min="0" step="0.1" />
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Lease Start</div>
                <div class="stat-value" id="leaseStart"></div>
            </div>
            <div class="stat">
                <div class="stat-label">Current Date</div>
                <div class="stat-value" id="currentDate"></div>
            </div>
            <div class="stat">
                <div class="stat-label">Days Elapsed</div>
                <div class="stat-value" id="daysElapsed"></div>
            </div>
            <div class="stat">
                <div class="stat-label">Annual Miles</div>
                <div class="stat-value" id="annualMilesDisplay"></div>
            </div>
            <div class="stat">
                <div class="stat-label">Projected Miles Used</div>
                <div class="stat-value" id="milesUsed"></div>
            </div>
            <div class="stat">
                <div class="stat-label">Actual Miles Used</div>
                <div class="stat-value" id="actualMilesUsed"></div>
            </div>
            <div class="stat" id="milesDiffStat">
                <div class="stat-label">Miles Over/Under</div>
                <div class="stat-value" id="milesDiff"></div>
            </div>
            <div class="stat" id="overageCostStat" style="display: none;">
                <div class="stat-label">Overage Cost ($)</div>
                <div class="stat-value" id="overageCost">0.00</div>
            </div>
            <div class="stat">
                <div class="stat-label">Miles Remaining</div>
                <div class="stat-value" id="milesRemaining"></div>
            </div>
        </div>
        
        <div class="note" id="noteText">
            This assumes full daily allotment usage each day from the start date.<br>
            Miles Over/Under = Actual - Projected. Positive = over (green!), Negative = under (pink).<br>
            Changes update automatically.
        </div>
    </div>

    <script>
        const DAYS_IN_YEAR = 365; // Non-leap year assumption for simplicity
        const OVERAGE_RATE = 0.10; // $0.10 per mile

        // Safe localStorage wrapper
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.warn('localStorage unavailable:', e);
                return null;
            }
        }

        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.warn('localStorage unavailable:', e);
                return false;
            }
        }

        // Function to parse date string to local Date object
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Function to calculate and update display
        function calculateAndUpdate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString();

            // Get selected start date
            let startDateStr = document.getElementById('startDateSelect').value;
            const storedStart = safeGetItem('leaseStartDate');
            if (storedStart !== null) {
                startDateStr = storedStart;
                document.getElementById('startDateSelect').value = storedStart;
            }
            const startDate = parseLocalDate(startDateStr);
            document.getElementById('leaseStart').textContent = startDate.toLocaleDateString();

            // Days elapsed: from start date to today, inclusive
            const timeDiff = now - startDate;
            const daysElapsed = Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1);
            document.getElementById('daysElapsed').textContent = daysElapsed;

            // Get selected annual miles
            let annualMiles = parseInt(document.getElementById('annualMilesSelect').value);
            const storedAnnual = safeGetItem('annualMiles');
            if (storedAnnual !== null) {
                annualMiles = parseInt(storedAnnual);
                document.getElementById('annualMilesSelect').value = storedAnnual;
            }
            document.getElementById('annualMilesDisplay').textContent = annualMiles.toLocaleString();
            const dailyMiles = annualMiles / DAYS_IN_YEAR;

            // Projected miles used (assuming full daily usage)
            const projectedUsed = Math.round(daysElapsed * dailyMiles);
            document.getElementById('milesUsed').textContent = projectedUsed.toLocaleString();

            // Actual miles used: prefer current input value, fallback to stored
            const input = document.getElementById('actualMiles');
            let actualUsed = 0;
            if (input.value !== '') {
                actualUsed = parseFloat(input.value) || 0;
            } else {
                const storedActual = safeGetItem('actualMiles');
                if (storedActual !== null) {
                    actualUsed = parseFloat(storedActual) || 0;
                }
            }
            document.getElementById('actualMilesUsed').textContent = actualUsed.toLocaleString();

            // Miles difference: actual - projected (positive = over, negative = under)
            const diff = actualUsed - projectedUsed;
            const milesDiffElement = document.getElementById('milesDiff');
            const milesDiffStat = document.getElementById('milesDiffStat');
            milesDiffElement.textContent = (diff >= 0 ? '+' : '') + diff.toLocaleString();
            if (diff >= 0) {
                milesDiffStat.className = 'stat over';
                milesDiffElement.style.color = '#155724';
            } else {
                milesDiffStat.className = 'stat under';
                milesDiffElement.style.color = '#721c24';
            }

            // Overage cost (only for April 23 start date)
            const overageCostStat = document.getElementById('overageCostStat');
            const overageCostElement = document.getElementById('overageCost');
            if (startDateStr === '2025-04-23') {
                const overageMiles = Math.max(0, diff);
                const cost = overageMiles * OVERAGE_RATE;
                overageCostElement.textContent = cost.toFixed(2);
                overageCostStat.style.display = 'block';
                if (diff > 0) {
                    overageCostStat.className = 'stat over';
                    overageCostElement.style.color = '#155724';
                } else {
                    overageCostStat.className = 'stat';
                    overageCostElement.style.color = '#28a745';
                }
            } else {
                overageCostStat.style.display = 'none';
            }

            // Miles remaining (based on projected)
            const remaining = Math.max(0, annualMiles - projectedUsed);
            document.getElementById('milesRemaining').textContent = remaining.toLocaleString();

            // Update note with daily allotment
            const dailyAllotment = Math.round(dailyMiles * 100) / 100;
            document.getElementById('noteText').innerHTML = `This assumes full daily allotment usage each day from the start date. Daily allotment: ~${dailyAllotment} miles (${annualMiles} / 365 days).<br>Miles Over/Under = Actual - Projected. Positive = over (green!), Negative = under (pink).<br>Changes update automatically.`;
        }

        // Function to update start date (and tie annual miles)
        function updateStartDate() {
            const select = document.getElementById('startDateSelect');
            safeSetItem('leaseStartDate', select.value);
            
            // Tie annual miles to date: April 23 -> 10k, August 9 -> 15k
            let tiedMiles = '15000'; // default
            if (select.value === '2025-04-23') {
                tiedMiles = '10000';
            }
            document.getElementById('annualMilesSelect').value = tiedMiles;
            safeSetItem('annualMiles', tiedMiles);
            
            calculateAndUpdate();
        }

        // Function to update annual miles
        function updateAnnualMiles() {
            const select = document.getElementById('annualMilesSelect');
            safeSetItem('annualMiles', select.value);
            calculateAndUpdate();
        }

        // Function to update actual miles
        function updateActualMiles() {
            const input = document.getElementById('actualMiles');
            const value = parseFloat(input.value);
            if (!isNaN(value) && value >= 0) {
                safeSetItem('actualMiles', value);
            }
            // Always update display with current input
            calculateAndUpdate();
        }

        // Initial load
        calculateAndUpdate();

        // Set initial input value after load
        const initialActual = safeGetItem('actualMiles');
        if (initialActual !== null) {
            document.getElementById('actualMiles').value = initialActual;
        }

        // Auto-update on inputs
        document.getElementById('startDateSelect').addEventListener('change', updateStartDate);
        document.getElementById('annualMilesSelect').addEventListener('change', updateAnnualMiles);
        document.getElementById('actualMiles').addEventListener('input', updateActualMiles);
    </script>
</body>
</html>
